version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.1.1
  gradle: circleci/gradle@3.0.0

jobs:
  publish:
    machine:
      image: ubuntu-2204:2023.02.1
    resource_class: large
    environment:
      _JAVA_OPTIONS: -Xmx9600m
      GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.logging.level=info
    steps:
      - setup
      - run: |
          chmod +x ./gradlew
          ./gradlew publish

commands:
  setup:
    steps:
      - checkout
      - gradle/with_cache:
          cache_key: 'v9'
          steps:
            - run:
                name: chmod permissions
                command: chmod +x ./gradlew
            - run: ./gradlew build --parallel --console=plain
      - store_artifacts:
          path: ~/project/build/libs

workflows:
  start:
    jobs:
      - path-filtering/filter:
          name: filter
          mapping: |
            src/.* allow-deploy-and-discord-publish false
          base-revision: << pipeline.git.branch >>
          config-path: .circleci/continue_config.yml
  publish:
    jobs:
      - publish:
          context:
            - maven
            - publishing
          filters:
            tags:
              only:
                - /.*/
            branches:
              ignore:
                - /.*/
